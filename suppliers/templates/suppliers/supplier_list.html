{% extends "base.html" %}

{% block title %}Fornecedores{% endblock title %}
{% block content %}
<div class="container mx-auto mt-10 max-w-4xl">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-semibold text-gray-800 dark:text-gray-100">Fornecedores</h1>
        <a href="{% url 'suppliers:supplier_create' %}"
            class="inline-flex items-center px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded hover:bg-blue-700 transition">
            <i class="fas fa-plus mr-2"></i> Novo Fornecedor
        </a>
    </div>

    {% if messages %}
    <div class="mb-4">
        {% for message in messages %}
        <div class="p-3 rounded {% if message.tags == 'error' %}bg-red-500{% elif message.tags == 'success' %}bg-green-500{% else %}bg-blue-500{% endif %} text-white">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="mb-4">
        <form method="get" class="flex flex-wrap items-end space-x-4 mb-8">
            <div class="flex-grow min-w-[150px]">
                <label for="filter_by" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Filtrar por</label>
                <select id="filter_by" name="filter_by" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="name" {% if request.GET.filter_by == 'name' %}selected{% endif %}>Nome</option>
                    <option value="cnpj" {% if request.GET.filter_by == 'cnpj' %}selected{% endif %}>CNPJ</option>
                </select>
            </div>

            <div class="flex-grow min-w-[200px]">
                <label for="q" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Termo de Pesquisa</label>
                <input 
                    type="text" 
                    id="q" 
                    name="q" 
                    placeholder="Pesquisar..." 
                    value="{{ request.GET.q|default:'' }}" 
                    class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
            </div>

            <div class="flex-shrink-0 flex items-center space-x-2">
                <a href="{% url 'suppliers:supplier_list' %}" class="bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-700 text-gray-800 dark:text-white font-semibold px-6 py-2 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-gray-500 flex items-center justify-center space-x-2">
                    <i class="fas fa-eraser"></i>
                    <span>Limpar</span>
                </a>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-2 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 flex items-center justify-center space-x-2">
                    <i class="fas fa-search"></i>
                    <span>Buscar</span>
                </button>
            </div>
        </form>
    </div>
    
    <!-- Adicionamos o scroll horizontal aqui -->
    <div class="overflow-x-auto bg-white dark:bg-gray-800 shadow rounded">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
            <thead class="bg-gray-100 dark:bg-gray-700">
                <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">Nome</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">CNPJ</th>
                    {% comment %} <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">Telefone</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">Contato</th> {% endcomment %}
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">Ações</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                {% for supplier in suppliers %}
                <tr>
                    <td class="px-4 py-3 text-gray-900 dark:text-gray-100">{{ supplier.name }}</td>
                    <td class="px-4 py-3 text-gray-900 dark:text-gray-100">{{ supplier.cnpj }}</td>
                    {% comment %} <td class="px-4 py-3 text-gray-900 dark:text-gray-100">{{ supplier.phone }}</td>
                    <td class="px-4 py-3 text-gray-900 dark:text-gray-100">{{ supplier.contact_person }}</td> {% endcomment %}
                    <td class="px-4 py-3 text-right space-x-2 whitespace-nowrap">
                        <!-- Novo botão Visualizar -->
                        <a href="{% url 'suppliers:supplier_detail' supplier.pk %}"
                            class="inline-flex items-center px-3 py-1.5 rounded-md text-sm font-medium 
                            text-white bg-green-600 hover:bg-green-700 
                            transition-all duration-200">
                            <i class="fas fa-eye mr-2"></i> Visualizar
                        </a>
                        <!-- Botão Editar -->
                        <a href="{% url 'suppliers:supplier_update' supplier.pk %}"
                            class="inline-flex items-center px-3 py-1.5 rounded-md text-sm font-medium 
                            text-white bg-blue-600 hover:bg-blue-700 
                            transition-all duration-200">
                            <i class="fas fa-pencil-alt mr-2"></i> Editar
                        </a>
                        <!-- Botão Excluir -->
                        <a href="#"
                            class="delete-supplier-btn inline-flex items-center px-3 py-1.5 rounded-md text-sm font-medium 
                            text-red-600 dark:text-red-400 
                            bg-red-100 dark:bg-red-900 
                            hover:bg-red-200 dark:hover:bg-red-800 
                            transition-all duration-200"
                            data-url="{% url 'suppliers:supplier_delete' supplier.pk %}"
                            data-name="{{ supplier.name }}">
                            <i class="fas fa-trash-alt mr-2"></i> Excluir
                        </a> 
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="px-4 py-3 text-center text-gray-500 dark:text-gray-400">Nenhum fornecedor cadastrado.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if is_paginated %}
    <div class="mt-4 flex justify-center space-x-2">
        {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}"
            class="px-4 py-2 rounded border transition-colors
            bg-gray-100 text-gray-700 hover:bg-gray-200 hover:text-black
            dark:bg-gray-800 dark:text-gray-200 dark:hover:bg-gray-700 dark:hover:text-white">
            &laquo; Anterior
        </a>
        {% endif %}

        <span class="px-4 py-2 rounded border font-semibold
            bg-gray-200 text-gray-800
            dark:bg-gray-700 dark:text-white">
            {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
        </span>

        {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}"
            class="px-4 py-2 rounded border transition-colors
            bg-gray-100 text-gray-700 hover:bg-gray-200 hover:text-black
            dark:bg-gray-800 dark:text-gray-200 dark:hover:bg-gray-700 dark:hover:text-white">
            Próxima &raquo;
        </a>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- Importa SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const deleteButtons = document.querySelectorAll('.delete-supplier-btn');
        
        deleteButtons.forEach(button => {
            button.addEventListener('click', function (e) {
                e.preventDefault();

                const supplierName = this.dataset.name;
                const deleteUrl = this.dataset.url;

                Swal.fire({
                    title: 'Tem certeza?',
                    text: `Deseja excluir o fornecedor "${supplierName}"?`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Sim, excluir',
                    cancelButtonText: 'Cancelar',
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Cria um formulário temporário e envia via POST
                        const form = document.createElement('form');
                        form.method = 'post';
                        form.action = deleteUrl;
                        form.style.display = 'none';

                        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                        const csrfInput = document.createElement('input');
                        csrfInput.name = 'csrfmiddlewaretoken';
                        csrfInput.value = csrfToken;
                        form.appendChild(csrfInput);

                        document.body.appendChild(form);
                        form.submit();
                    }
                });
            });
        });
    });
</script>
{% endblock %}
